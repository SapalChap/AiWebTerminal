<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Web Terminal</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            color: #fff !important;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            height: 100vh;
        }

        .terminal {
            height: 100vh;
            padding: 20px;
            background: #000;
        }

        .cursor {
            background-color: #fff;
            animation: blink 1s infinite;
            width: 8px;
            height: 16px;
            display: inline-block;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Loading indicator for when request is processing */
        .loading {
            color: #888 !important;
        }

        .response-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="terminal">
        <div>AI Web Terminal v1.0.0 : A minimal AI chatbot.</div>
        <div>Copyright (c) 2025 AI Web Terminal. All rights reserved.</div>
        <br>
        <div>System initialized successfully.</div>
        <div>Welcome to AI Minimal Terminal!</div>
        <div>Type !help for available commands</div>
        <div id="output"></div>
        <div style="display: flex; align-items: center; flex-wrap: nowrap;">
            <span style="white-space: nowrap; margin-right: 5px;">user@aiwebterminal:~$ </span>
            <input type="text" id="command-input" style="background: transparent; border: none; color: #fff; font-family: 'Courier New', monospace; font-size: 14px; outline: none; flex: 1; min-width: 200px;">
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('command-input');
        
        // Track current AI model (default to deepseek)
        let currentModel = 'deepseek';
        
        // Track last AI response for copying
        let lastResponse = '';
        
        // Track ongoing request for cancellation
        let currentAbortController = null;
        let isProcessing = false;
        
        // Global code block counter (increments when user copies code)
        let globalCodeBlockCounter = 0;

        // Function to extract specific code block from response
        function extractCodeBlock(responseText, blockNumber) {
            const regex = /```[\w\s]*:\s*code block (\d+) start\n([\s\S]*?)\n``` code block \1 end/g;
            let match;
            let currentBlock = 0;
            
            while ((match = regex.exec(responseText)) !== null) {
                currentBlock++;
                if (currentBlock === blockNumber) {
                    return match[2]; // Return the code content
                }
            }
            
            return null; // Block not found
        }

        // Function to count total code blocks in response
        function countCodeBlocks(responseText) {
            const regex = /```[\w\s]*:\s*code block (\d+) start\n([\s\S]*?)\n``` code block \1 end/g;
            let count = 0;
            while (regex.exec(responseText) !== null) {
                count++;
            }
            return count;
        }
        
        // Function to handle special commands (model switching, clear, etc.)
        function handleSpecialCommand(command) {
            const cmd = command.toLowerCase();
            
            // Handle model switching
            if (cmd.startsWith('!aimodel ')) {
                const modelName = cmd.split(' ')[1];
                
                // Check if it's a valid model
                const validModels = ['deepseek', 'llama', 'gemini'];
                
                if (validModels.includes(modelName)) {
                    currentModel = modelName;
                    return `Model switched to: ${modelName}`;
                } else {
                    return `Invalid model. Available models: ${validModels.join(', ')}`;
                }
            }
            
            // Handle clear command
            if (cmd === '!clear') {
                output.innerHTML = ''; // Clear all chat history
                lastResponse = ''; // Clear last response too
                return 'Chat history cleared.';
            }
            
            // Handle copy command
            if (cmd === '!copy') {
                if (lastResponse) {
                    // Copy to clipboard using the Clipboard API
                    navigator.clipboard.writeText(lastResponse).then(() => {
                        // Success handled by return statement below
                    }).catch(err => {
                        console.error('Failed to copy to clipboard:', err);
                    });
                    return 'Last response copied to clipboard! (Ctrl+V to paste)';
                } else {
                    return 'No response to copy. Send a message first.';
                }
            }
            
            // Handle copy code command
            if (cmd.startsWith('!cc')) {
                const blockNumStr = cmd.replace('!cc', '');
                const blockNum = parseInt(blockNumStr);
                
                if (isNaN(blockNum) || blockNum < 1) {
                    return 'Invalid format. Use !cc1, !cc2, etc.';
                }
                
                if (!lastResponse) {
                    return 'No AI response to extract code from.';
                }
                
                const codeContent = extractCodeBlock(lastResponse, blockNum);
                
                if (codeContent) {
                    // Copy to clipboard
                    navigator.clipboard.writeText(codeContent).then(() => {
                        // Success handled by return statement below
                    }).catch(err => {
                        console.error('Failed to copy code to clipboard:', err);
                    });
                    
                    // Increment global counter only when successfully copying
                    globalCodeBlockCounter++;
                    
                    return `Code block ${blockNum} copied to clipboard! (Global copy #${globalCodeBlockCounter})`;
                } else {
                    const totalBlocks = countCodeBlocks(lastResponse);
                    if (totalBlocks === 0) {
                        return 'AI Web Terminal didn\'t find any code blocks.';
                    } else {
                        return `Code block ${blockNum} not found. Available blocks: 1-${totalBlocks}`;
                    }
                }
            }
            
            // Handle help command
            if (cmd === '!help') {
                const helpText = `Available Commands:

!help - Show this help message

!aimodel [model] - Switch AI model (deepseek, llama, gemini). Ex: !aimodel deepseek

!clear - Clear chat history

!copy - Copy last response to clipboard

!cc[n] - Copy code block n to clipboard. Ex: !cc1, !cc2

!stop - Stop current AI processing

!exit - Exit the terminal

For support/ feature requests, send me an email: sapalcdev@gmail.com

Created by SapalChap

Just type your message to chat with the AI!`;
                return helpText;
            }
            
            // Handle stop command
            if (cmd === '!stop') {
                if (isProcessing && currentAbortController) {
                    currentAbortController.abort();
                    currentAbortController = null;
                    isProcessing = false;
                    return 'Processing stopped.';
                } else {
                    return 'No active processing to stop.';
                }
            }
            
            // Handle exit command
            if (cmd === '!exit') {
                // Show goodbye message first
                setTimeout(() => {
                    // Try to close the window/tab
                    window.close();
                    
                    // If window.close() doesn't work (due to browser restrictions),
                    // show alternative instructions
                    setTimeout(() => {
                        const exitMessage = document.createElement('div');
                        exitMessage.textContent = 'Auto window close was blocked by your browser. Please close this browser tab manually (Ctrl+W or click the X button). Thank you for using AI Web Terminal!';
                        exitMessage.style.color = '#ff6666';
                        output.appendChild(exitMessage);
                    }, 500);
                }, 1000);
                
                return 'Thanks for using AI Web Terminal! Closing...';
            }
            
            // Check if command starts with ! but is not a valid command
            if (cmd.startsWith('!')) {
                return 'Not a valid command. Type !help for documentation.';
            }
            
            return null; // Not a special command
        }
        
        // Function to send command to Flask backend
        async function executeCommand(command) {
            try {
                // Create new AbortController for this request
                currentAbortController = new AbortController();
                isProcessing = true;
                
                const response = await fetch('/execute_command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        command: command,
                        model: currentModel  // Send current model to Flask
                    }),
                    signal: currentAbortController.signal  // Add abort signal
                });
                
                const data = await response.json();
                
                // Reset processing state
                isProcessing = false;
                currentAbortController = null;
                
                if (data.success) {
                    return data.response;
                } else {
                    return 'Error: Command execution failed';
                }
            } catch (error) {
                // Reset processing state
                isProcessing = false;
                currentAbortController = null;
                
                if (error.name === 'AbortError') {
                    return 'Request was cancelled.';
                }
                
                console.error('Error:', error);
                return 'Error: Failed to communicate with server';
            }
        }
        
        // Handle Enter key press
        input.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const command = input.value.trim();
                
                if (command === '') return;
                
                // Add command to output
                const commandLine = document.createElement('div');
                commandLine.textContent = `user@aiwebterminal:~$ ${command}`;
                output.appendChild(commandLine);
                
                // Clear input immediately after capturing command
                input.value = '';
                
                // Check if it's a special command (model switching, clear, etc.)
                const specialResponse = handleSpecialCommand(command);
                
                if (specialResponse) {
                    // Handle special commands locally
                    const responseLine = document.createElement('div');
                    responseLine.textContent = specialResponse;
                    responseLine.style.color = '#00ff00'; // Green color for system messages
                    responseLine.style.whiteSpace = 'pre-wrap'; // Preserve line breaks and formatting
                    output.appendChild(responseLine);
                } else {
                    // Show loading indicator for AI requests
                    const loadingLine = document.createElement('div');
                    loadingLine.textContent = 'Processing...';
                    loadingLine.className = 'loading';
                    output.appendChild(loadingLine);
                    
                    try {
                        // Execute command via Flask backend
                        const response = await executeCommand(command);
                        
                        // Store response for copying
                        lastResponse = response;
                        
                        // Remove loading indicator if it still exists
                        if (loadingLine.parentNode) {
                            output.removeChild(loadingLine);
                        }
                        
                        // Add response to output
                        const responseLine = document.createElement('div');
                        responseLine.textContent = response;
                        responseLine.style.whiteSpace = 'pre-wrap'; // Preserve formatting
                        output.appendChild(responseLine);
                    } catch (error) {
                        // Remove loading indicator if it still exists
                        if (loadingLine.parentNode) {
                            output.removeChild(loadingLine);
                        }
                        
                        // Show error message
                        const errorLine = document.createElement('div');
                        errorLine.textContent = 'Request was cancelled or failed.';
                        errorLine.style.color = '#ff6666';
                        output.appendChild(errorLine);
                    }
                }
                
                // Scroll to bottom
                output.scrollTop = output.scrollHeight;
            }
        });

        // Keep input focused
        input.focus();
        
        // Refocus input when clicking anywhere on terminal
        document.addEventListener('click', () => {
            input.focus();
        });
    </script>
</body>
</html>